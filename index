<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° & ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen pb-10">

    <div id="auth-ui" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-xl mt-10 border border-slate-100">
        <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
        <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 border outline-none focus:border-indigo-500">
        <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 border outline-none focus:border-indigo-500">
        <div class="flex gap-2">
            <button onclick="signIn()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button onclick="signUp()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold active:scale-95 transition">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="app-ui" class="hidden max-w-md mx-auto p-4 space-y-4">
        <div class="flex justify-between items-center text-[10px] font-bold text-gray-400">
            <span id="user-display"></span>
            <button onclick="signOut()" class="text-red-400 underline uppercase">Sign Out</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="bg-blue-600 text-white p-5 rounded-3xl shadow-lg">
                <p class="text-[10px] opacity-80 uppercase font-bold">Total Saving</p>
                <h1 id="sum-saving" class="text-xl font-bold">‡∏ø0.00</h1>
            </div>
            <div class="bg-emerald-600 text-white p-5 rounded-3xl shadow-lg">
                <p class="text-[10px] opacity-80 uppercase font-bold">Net Balance</p>
                <h1 id="sum-net" class="text-xl font-bold">‡∏ø0.00</h1>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border space-y-3">
            <input type="number" id="amount" placeholder="0.00" class="w-full p-4 bg-gray-50 rounded-xl border-none outline-none text-center text-2xl font-bold text-gray-700">
            <div class="grid grid-cols-3 gap-2">
                <button onclick="addTrans('saving')" class="bg-blue-100 text-blue-600 p-3 rounded-xl text-xs font-bold active:bg-blue-200">‚ûï ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button onclick="addTrans('income')" class="bg-green-100 text-green-600 p-3 rounded-xl text-xs font-bold active:bg-green-200">üìà ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                <button onclick="addTrans('expense')" class="bg-red-100 text-red-600 p-3 rounded-xl text-xs font-bold active:bg-red-200">üìâ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border">
            <h3 class="font-bold text-sm text-gray-700 mb-3">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="history-list" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                <p class="text-center text-gray-400 text-[10px] py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm text-gray-700">üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ (50 ‡∏á‡∏ß‡∏î)</h3>
                <span id="debt-status" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-lg">0/50</span>
            </div>
            <div id="debt-grid" class="grid grid-cols-5 gap-2"></div>
        </div>
    </div>

    <script>
        // *** ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        const SB_URL = 'https://outuhvsmvmbseccdfvwb.supabase.co';
        const SB_KEY = 'sb_publishable_WKuvVWnMiDtPmgQXSzP_xA_lWOdOUyK';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('app-ui').classList.remove('hidden');
                document.getElementById('user-display').innerText = `USER: ${session.user.email}`;
                loadData();
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
                document.getElementById('app-ui').classList.add('hidden');
            }
        });

        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            const { error } = await _supabase.auth.signUp({ email, password });
            if (error) alert(error.message); else alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) alert("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }

        async function signOut() { await _supabase.auth.signOut(); }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function loadData() {
            // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            const { data: trans } = await _supabase.from('transactions').select('*').order('created_at', { ascending: false });
            
            let saving = 0, income = 0, expense = 0;
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if(trans && trans.length > 0) {
                trans.forEach(t => {
                    if(t.type === 'saving') saving += t.amount;
                    if(t.type === 'income') income += t.amount;
                    if(t.type === 'expense') expense += t.amount;

                    const date = new Date(t.created_at).toLocaleString('th-TH', { 
                        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
                    });
                    
                    let typeText = '', typeColor = '', sign = '+';
                    if(t.type === 'saving') { typeText = '‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô'; typeColor = 'text-blue-600'; }
                    if(t.type === 'income') { typeText = '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'; typeColor = 'text-green-600'; }
                    if(t.type === 'expense') { typeText = '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'; typeColor = 'text-red-600'; sign = '-'; }

                    historyList.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-2xl border-b border-gray-100">
                            <div>
                                <p class="text-[10px] font-bold ${typeColor}">${typeText}</p>
                                <p class="text-[9px] text-gray-400">${date}</p>
                            </div>
                            <p class="font-bold text-sm ${typeColor}">${sign}${t.amount.toLocaleString()}</p>
                        </div>
                    `;
                });
            } else {
                historyList.innerHTML = '<p class="text-center text-gray-400 text-[10px] py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
            }

            document.getElementById('sum-saving').innerText = `‡∏ø${saving.toLocaleString()}`;
            document.getElementById('sum-net').innerText = `‡∏ø${(income - expense).toLocaleString()}`;

            // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ
            const { data: debts } = await _supabase.from('debts').select('*');
            const grid = document.getElementById('debt-grid');
            grid.innerHTML = '';
            let paidCount = 0;
            for(let i=1; i<=50; i++) {
                const isPaid = debts?.find(d => d.installment_no === i)?.is_paid;
                if(isPaid) paidCount++;
                grid.innerHTML += `
                    <div onclick="toggleDebt(${i}, ${isPaid})" 
                         class="aspect-square flex items-center justify-center rounded-xl font-bold cursor-pointer text-[10px] transition
                         ${isPaid ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-400 border border-gray-200'}">
                        ${i}
                    </div>`;
            }
            document.getElementById('debt-status').innerText = `${paidCount}/50 ‡∏á‡∏ß‡∏î`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô
        async function addTrans(type) {
            const amtInput = document.getElementById('amount');
            const amt = parseFloat(amtInput.value);
            if(!amt || amt <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            
            const { data: { user } } = await _supabase.auth.getUser();
            const { error } = await _supabase.from('transactions').insert([{ 
                amount: amt, 
                type: type, 
                user_id: user.id 
            }]);
            
            if (!error) { amtInput.value = ''; loadData(); } else { alert(error.message); }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏¥‡πä‡∏Å‡∏´‡∏ô‡∏µ‡πâ
        async function toggleDebt(num, status) {
            const { data: { user } } = await _supabase.auth.getUser();
            const { error } = await _supabase.from('debts').upsert({ 
                installment_no: num, 
                is_paid: !status, 
                user_id: user.id 
            }, { onConflict: 'installment_no, user_id' });
            if (!error) loadData();
        }
    </script>
</body>
</html>
