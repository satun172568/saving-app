<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <div id="auth-ui" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-xl mt-10 border border-slate-100">
        <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</h2>
        <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 outline-none border focus:border-indigo-500">
        <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 outline-none border focus:border-indigo-500">
        <div class="flex gap-2">
            <button onclick="signIn()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button onclick="signUp()" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="app-ui" class="hidden max-w-md mx-auto p-4 space-y-6">
        
        <div class="flex justify-between items-center mt-4">
            <p id="user-display" class="text-[10px] font-bold text-slate-400 uppercase"></p>
            <button onclick="signOut()" class="text-[10px] text-red-500 font-bold underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="bg-gradient-to-br from-indigo-600 to-indigo-900 text-white p-8 rounded-[2.5rem] shadow-xl text-center">
            <p class="text-indigo-100 text-sm mb-1 opacity-80 font-light">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <h1 id="total-balance" class="text-5xl font-bold tracking-tight">‡∏ø 0.00</h1>
        </div>

        <div class="grid grid-cols-1 gap-3">
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-2">
                <span class="text-xs font-bold text-blue-500 min-w-[70px]">üí∞ ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
                <input type="number" id="save-amt" placeholder="0.00" class="flex-1 bg-transparent outline-none font-bold text-slate-700">
                <button onclick="saveMoney('save-amt', '‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô')" class="bg-blue-500 text-white px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-2">
                <span class="text-xs font-bold text-green-500 min-w-[70px]">üìà ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                <input type="number" id="income-amt" placeholder="0.00" class="flex-1 bg-transparent outline-none font-bold text-slate-700">
                <button onclick="saveMoney('income-amt', '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö')" class="bg-green-500 text-white px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-2">
                <span class="text-xs font-bold text-red-500 min-w-[70px]">üìâ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                <input type="number" id="expense-amt" placeholder="0.00" class="flex-1 bg-transparent outline-none font-bold text-slate-700">
                <button onclick="saveMoney('expense-amt', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢')" class="bg-red-500 text-white px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-800 text-sm mb-3 underline decoration-indigo-200">üìú ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div id="history-list" class="space-y-3 max-h-60 overflow-y-auto pr-1">
                <p class="text-center text-slate-300 text-xs py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800 text-sm">üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</h3>
                <span id="paid-count" class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-[10px] font-bold">0/50</span>
            </div>
            <div id="debt-grid" class="grid grid-cols-5 gap-2"></div>
        </div>
    </div>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SB_URL = 'https://outuhvsmvmbseccdfvwb.supabase.co';
        const SB_KEY = 'sb_publishable_WKuvVWnMiDtPmgQXSzP_xA_lWOdOUyK'; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('app-ui').classList.remove('hidden');
                document.getElementById('user-display').innerText = session.user.email;
                loadData();
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
                document.getElementById('app-ui').classList.add('hidden');
            }
        });

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + error.message);
        }

        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await _supabase.auth.signUp({ email, password });
            if (error) alert(error.message); else alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        }

        async function signOut() { await _supabase.auth.signOut(); }

        async function saveMoney(inputId, note) {
            const amt = document.getElementById(inputId).value;
            if(!amt) return;
            const { data: { user } } = await _supabase.auth.getUser();
            let finalAmt = (note === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') ? -parseFloat(amt) : parseFloat(amt);
            const { error } = await _supabase.from('transactions').insert([{ amount: finalAmt, user_id: user.id, note: note }]);
            if (!error) { document.getElementById(inputId).value = ''; loadData(); }
        }

        async function loadData() {
            const { data: trans } = await _supabase.from('transactions').select('*').order('created_at', { ascending: false });
            let total = 0;
            const historyDiv = document.getElementById('history-list');
            historyDiv.innerHTML = '';
            if (trans && trans.length > 0) {
                trans.forEach(t => {
                    total += t.amount;
                    const date = new Date(t.created_at).toLocaleDateString('th-TH', {day:'numeric', month:'short'});
                    historyDiv.innerHTML += `
                        <div class="flex justify-between items-center text-xs border-b border-slate-50 pb-2">
                            <div><p class="font-bold text-slate-600">${t.note || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'}</p><p class="text-[10px] text-slate-400">${date}</p></div>
                            <p class="font-bold ${t.amount > 0 ? 'text-green-500' : 'text-red-500'}">${t.amount > 0 ? '+' : ''}${t.amount.toLocaleString()}</p>
                        </div>`;
                });
            } else {
                historyDiv.innerHTML = '<p class="text-center text-slate-300 text-xs py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
            }
            document.getElementById('total-balance').innerText = `‡∏ø ${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

            const { data: debts } = await _supabase.from('debts').select('*');
            const grid = document.getElementById('debt-grid');
            grid.innerHTML = '';
            let count = 0;
            for(let i=1; i<=50; i++) {
                const isPaid = debts?.find(d => d.installment_no === i)?.is_paid;
                if(isPaid) count++;
                grid.innerHTML += `<div onclick="toggleDebt(${i}, ${isPaid})" class="aspect-square flex items-center justify-center rounded-xl font-bold cursor-pointer text-xs ${isPaid ? 'bg-green-500 text-white shadow-lg' : 'bg-slate-100 text-slate-400'}">${i}</div>`;
            }
            document.getElementById('paid-count').innerText = `${count}/50`;
        }

        async function toggleDebt(num, status) {
            const { data: { user } } = await _supabase.auth.getUser();
            // ‡∏ï‡∏¥‡πä‡∏Å‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏±‡∏ô SQL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
            await _supabase.from('debts').upsert({ installment_no: num, is_paid: !status, user_id: user.id }, { onConflict: 'installment_no, user_id' });
            loadData();
        }
    </script>
</body>
</html>